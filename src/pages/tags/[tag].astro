---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/Layout.astro";
import type {
  GetStaticPaths,
  InferGetStaticParamsType,
  InferGetStaticPropsType,
} from "astro";

export const getStaticPaths = (async () => {
  const allPosts = await getCollection("blog");

  const tagMap = new Map<string, any[]>();
  for (const post of allPosts) {
    (post.data.tags || []).forEach((tag: any) => {
      if (!tagMap.has(tag)) tagMap.set(tag, []);

      tagMap.get(tag)?.push(post);
    });
  }

  return [...tagMap.entries()].map(([tag, posts]) => ({
    params: { tag },
    props: { posts },
  }));
}) satisfies GetStaticPaths;

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { tag } = Astro.params as Params;
const { posts } = Astro.props as Props;
---

<BaseLayout pageTitle={`Posts tagged "${tag}"`}>
  <h2>Posts tagged with {tag}</h2>
  <ul>
    {
      posts.map((post: any) => (
        <li>
          <a href={`/posts/${post.id}`}>{post.data.title} </a>
        </li>
      ))
    }
  </ul>
</BaseLayout>
